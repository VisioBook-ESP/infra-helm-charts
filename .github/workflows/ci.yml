name: Helm Unit Tests

on:
  push:
  pull_request:

jobs:
  lint:
    name: ğŸ§ª Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Lint all charts
        run: |
          helm lint environnement/dev/charts/* --strict

  validate:
    name: ğŸ“„ Helm Template Validation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Validate Helm templates
        run: |
          helm template environnement/dev/charts/*

  unittest:
    name: âœ… Helm Unit Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Install helm-unittest plugin
        run: helm plugin install https://github.com/helm-unittest/helm-unittest

      - name: Run helm-unittest on all charts
        run: |
          cd environnement/dev
          helm unittest charts/*

  kubeval:
    name: ğŸ” Validate Kubernetes Manifests with kubeval
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          curl -sL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar xz
          sudo mv kubeval /usr/local/bin/

      - name: Run kubeval on Helm templates
        run: |
          for chart in environnement/dev/charts/*; do
            if [ -f "$chart/Chart.yaml" ]; then
              echo "ğŸ” Validating with kubeval: $chart"
              helm template "$chart" | kubeval --ignore-missing-schemas --strict
            fi
          done

  minikube:
    name: ğŸ—ï¸ Deploy and Test NGINX via Helm on Minikube
    runs-on: ubuntu-latest
    needs: kubeval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          KUBECTL_VERSION="v1.30.1"
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl

      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          kubernetes-version: v1.30.1

      - name: Start Minikube
        run: |
          kubectl cluster-info

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Add Bitnami repo
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Deploy NGINX via Helm
        run: |
          helm upgrade --install my-nginx bitnami/nginx \
            --set service.type=ClusterIP \
            --wait --timeout 120s

      - name: Check pods status
        run: kubectl get pods -A

      - name: Port-forward NGINX
        run: |
          nohup kubectl port-forward svc/my-nginx 8080:80 &
          sleep 5

      - name: Test NGINX with curl
        run: |
          curl --retry 5 --retry-delay 5 http://127.0.0.1:8080
