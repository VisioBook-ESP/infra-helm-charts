name: Helm Unit Tests

on:
  push:
  pull_request:

jobs:
  lint:
    name: 🧪 Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Lint all charts
        run: |
          helm lint environnement/dev/charts/* --strict

  validate:
    name: 📄 Helm Template Validation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Validate Helm templates
        run: |
          helm template environnement/dev/charts/*

  unittest:
    name: ✅ Helm Unit Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Install helm-unittest plugin
        run: helm plugin install https://github.com/helm-unittest/helm-unittest

      - name: Run helm-unittest on all charts
        run: |
          cd environnement/dev
          helm unittest charts/*

  kubeval:
    name: 🔍 Validate Kubernetes Manifests with kubeval
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          curl -sL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar xz
          sudo mv kubeval /usr/local/bin/

      - name: Run kubeval on Helm templates
        run: |
          for chart in environnement/dev/charts/*; do
            if [ -f "$chart/Chart.yaml" ]; then
              echo "🔍 Validating with kubeval: $chart"
              helm template "$chart" | kubeval --ignore-missing-schemas --strict
            fi
          done

  minikube:
    name: 🏗️ Deploy and Test NGINX via Helm on Minikube
    runs-on: ubuntu-latest
    needs: kubeval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          KUBECTL_VERSION="v1.30.1"
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl

      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          kubernetes-version: v1.30.1

      - name: Start Minikube
        run: |
          kubectl cluster-info

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Add NGINX Helm repo
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Deploy simple NGINX with Helm
        run: |
          # Option 1: utiliser le chart Bitnami NGINX
          helm install my-nginx bitnami/nginx --set service.type=NodePort --wait --timeout 120s

          # Option 2 (alternatif) : utiliser ingress-nginx controller
          #helm install my-ingress ingress-nginx/ingress-nginx --wait --timeout 120s

      - name: Check pods status
        run: kubectl get pods -A

      - name: Expose service (if needed)
        run: |
          kubectl expose deployment my-nginx --type=NodePort --name=my-nginx-service

      - name: Get Minikube IP
        id: get_ip
        run: echo "MINIKUBE_IP=$(minikube ip)" >> $GITHUB_ENV

      - name: Test NGINX with curl
        run: |
          NODE_PORT=$(kubectl get svc my-nginx-service -o=jsonpath='{.spec.ports[0].nodePort}')
          echo "Testing NGINX on http://$MINIKUBE_IP:$NODE_PORT"
          curl --retry 5 --retry-delay 5 http://$MINIKUBE_IP:$NODE_PORT

